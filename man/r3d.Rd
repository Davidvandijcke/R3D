% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/r3d_main.R
\name{r3d}
\alias{r3d}
\title{Regression Discontinuity Design with Distribution-Valued Outcomes (R3D)}
\usage{
r3d(
  X,
  Y_list,
  T = NULL,
  cutoff = 0,
  method = c("simple", "frechet"),
  p = 2,
  q_grid = seq(0.01, 0.99, 0.01),
  fuzzy = FALSE,
  kernel_fun = c("epanechnikov", "triangular", "uniform"),
  s = 1,
  bandwidths = NULL,
  boot = FALSE,
  boot_reps = 200,
  boot_cores = 1,
  alpha = 0.05,
  test = c("none", "nullity", "homogeneity", "gini"),
  test_ranges = NULL,
  coverage = FALSE,
  weights = NULL,
  ...
)
}
\arguments{
\item{X}{Numeric vector of running variable values (length \eqn{n}).}

\item{Y_list}{A list of length \eqn{n}, where each element is a numeric vector
representing the sample from the outcome distribution of one unit.}

\item{T}{(Optional) For a fuzzy design: numeric or logical vector of length \eqn{n}
giving partial treatment status (0 or 1). If \code{fuzzy=FALSE}, this can be omitted.}

\item{cutoff}{Numeric scalar: the threshold for treatment assignment. The design
treats \eqn{X \ge cutoff} as above the cutoff.}

\item{method}{Either \code{"simple"} or \code{"frechet"}:
\describe{
\item{\code{"simple"}}{Local polynomial regression is done \emph{pointwise} for each quantile,
and then optionally rearranged to maintain monotonicity.}
\item{\code{"frechet"}}{A global local Fréchet regression approach is done, projecting
the entire curve onto quantile functions.}
}}

\item{p}{Integer specifying the local polynomial order (e.g., 2 for local quadratic).}

\item{q_grid}{Numeric vector of quantiles at which to estimate the distributional treatment effect.}

\item{fuzzy}{Logical flag for fuzzy design. Default \code{FALSE} for a sharp design.}

\item{kernel_fun}{Name of the kernel function. Possible choices are
\code{"epanechnikov"}, \code{"triangular"}, or \code{"uniform"}.
Defaults to \code{"triangular"}.}

\item{s}{Integer expansion order in the pilot local polynomial step used for bandwidth
selection. Defaults to 1.}

\item{bandwidths}{Optional user-specified bandwidths. If \code{NULL} (default), bandwidths are
automatically selected via \code{\link{r3d_bwselect}}. For a sharp design, can be
either a single numeric value or a vector of length \code{length(q_grid)}. For a fuzzy design,
must be a list with two components: \code{num} (for the outcome equation) and \code{den} (for the
first-stage equation). Where \code{num} can be a scalar or vector of length \code{length(q_grid)},
and \code{den} must be a scalar.}

\item{boot}{Logical. If \code{TRUE}, automatically runs \code{\link{r3d_bootstrap}}
after estimation to produce uniform confidence bands and tests.}

\item{boot_reps}{Integer, number of bootstrap draws if \code{boot=TRUE}.}

\item{boot_cores}{Number of CPU cores for parallelizing the bootstrap. Default 1.}

\item{alpha}{Significance level for the uniform confidence bands. Default 0.05.}

\item{test}{Character vector of tests to perform. Options include: \code{"none"}, \code{"nullity"},
\code{"homogeneity"}, or \code{"gini"}, or a vector combining multiple test types. When \code{"none"},
no tests are performed. When \code{"nullity"}, tests the null hypothesis that the treatment effect
is zero across all quantiles. When \code{"homogeneity"}, tests the null hypothesis that the
treatment effect is constant across all quantiles. When \code{"gini"}, tests the null hypothesis
that there is no difference in the Gini coefficients of the distributions above and below the cutoff.}

\item{test_ranges}{List of numeric vectors defining the quantile ranges for testing. Each element should be a
vector of length 2 or more defining the ranges. For example, \code{list(c(0.25, 0.75))} to test on
quantiles between 0.25 and 0.75, or \code{list(c(0.25, 0.5, 0.75))} to test on ranges \link{0.25, 0.5} and \link{0.5, 0.75}.
If \code{NULL} (default), tests are performed on the entire \code{q_grid}.}

\item{coverage}{Logical indicating whether to apply the coverage correction rule of thumb of
\insertCite{calonico2018effect;textual}{R3D}. Default is FALSE.}

\item{weights}{Optional numeric vector of weights for each observation that will be used to compute weighted quantiles. Defaults to unweighted.}

\item{...}{Additional arguments passed to the bandwidth selection function \code{\link{r3d_bwselect}}.}
}
\value{
An S3 object of class \code{"r3d"}, containing (among others):
\describe{
\item{\code{tau}}{Estimated distributional treatment effect \eqn{\tau(q)} for each \eqn{q} in \code{q_grid}.}
\item{\code{q_grid}}{The quantile grid used.}
\item{\code{bandwidths}}{The bandwidths used (either user-provided or MSE-/IMSE-optimal).}
\item{\code{w_plus}, \code{w_minus}}{The internal local polynomial weights on the plus/minus side.}
\item{\code{e1_mat}, \code{e2_mat}}{Residual matrices used for the multiplier bootstrap.}
\item{\code{boot_out}}{If \code{boot=TRUE}, a list of bootstrap results from \code{\link{r3d_bootstrap}}.}
}
}
\description{
Fits a regression discontinuity design with \emph{distribution-valued} outcomes (random distributions),
as developed in \insertCite{vandijcke2025;textual}{R3D},
using local polynomial regression on quantiles (\code{method="simple"}) or local Fréchet regression
(\code{method="frechet"}). Supports both sharp and fuzzy designs.
}
\details{
This is the main user-facing function for the R3D approach. Internally, it:
\enumerate{
\item Selects bandwidth(s) via \code{\link{r3d_bwselect}} (if \code{bandwidths=NULL}) or
uses user-provided bandwidths,
\item Computes local polynomial fits on each side of the cutoff for each quantile in \code{q_grid},
\item For \code{method="frechet"}, performs a projection of the fitted quantile curves onto the
space of valid quantile functions (via isotonic regression),
\item (Optionally) runs the multiplier bootstrap for uniform inference.
}

When \code{test} includes one or more test types and \code{test_ranges} is specified, the function will
perform the specified tests on each range in \code{test_ranges}. For example, if \code{test=c("nullity", "homogeneity")}
and \code{test_ranges=list(c(0.25, 0.75), c(0.1, 0.9))}, four tests will be performed: nullity and homogeneity
tests on the range \link{0.25, 0.75}, and nullity and homogeneity tests on the range \link{0.1, 0.9}.

The Gini test (\code{test="gini"}) examines whether there is a statistically significant difference in
inequality (as measured by the Gini coefficient) between the distributions above and below the cutoff.
It uses the estimated conditional quantile functions to calculate the Gini coefficients.
}
\examples{
\dontrun{
  # Simulate data
  set.seed(123)
  n <- 100
  X <- runif(n, -1, 1)
  Y_list <- lapply(seq_len(n), function(i) {
    # Suppose distribution is Normal with mean depending on X
    rnorm(sample(30:50,1), mean=2 + 2*(X[i]>=0))
  })
  T <- as.numeric(X >= 0) * rbinom(n, 1, 0.8)  # Fuzzy treatment

  # Example 1: Test nullity and homogeneity on full range
  fit1 <- r3d(X, Y_list, T=T, cutoff=0,
              method="frechet", p=2, fuzzy=TRUE,
              boot=TRUE, boot_reps=200, alpha=0.05, 
              test=c("nullity", "homogeneity"))

  # Example 2: Test Gini coefficient difference
  fit2 <- r3d(X, Y_list, cutoff=0, method="simple", 
              boot=TRUE, test="gini")
              
  # Example 3: Test on multiple ranges
  fit3 <- r3d(X, Y_list, cutoff=0, 
              boot=TRUE, test=c("nullity", "homogeneity", "gini"), 
              test_ranges=list(c(0.25, 0.5, 0.75)))

  # Inspect results
  print(fit1)
  summary(fit1)
  plot(fit1)
}

}
\references{
\insertAllCited{}
}
\seealso{
\code{\link{r3d_bootstrap}}, \code{\link{plot.r3d}}, \code{\link{summary.r3d}}
}
