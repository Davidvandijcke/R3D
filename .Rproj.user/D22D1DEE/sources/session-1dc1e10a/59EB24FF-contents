#' @title Monotone Projection (Isotonic) for Quantile Functions
#'
#' @description
#' Given a numerical vector of estimated average quantiles at points \code{q_grid},
#' project it onto the space of nondecreasing functions. This corresponds to an
#' L^2 projection on 1D distributional data (Frechet approach).
#'
#' @param mhat A numeric vector of length \code{length(q_grid)}.
#' @param q_grid A numeric vector, the quantile grid in ascending order.
#'
#' @return A numeric vector of the same length, but forced to be monotone nondecreasing.
#' @keywords internal
.monotone_projection <- function(mhat, q_grid) {
  # We assume q_grid is sorted. If not, sort it and reorder.
  # We'll use stats::isoreg if available, or a simple check.
  
  # Make sure q_grid is sorted ascending
  if (any(diff(q_grid) < 0)) {
    stop("q_grid must be sorted ascending.")
  }
  # isoreg can do isotonic regression in the y-values as a function of x-values
  iso_fit <- stats::isoreg(x = q_grid, y = mhat)
  # iso_fit$yf are the fitted values, which are monotonic
  # but note that it might have length < length(q_grid) if there are ties in q_grid
  # Usually it's the same though. We do:
  out <- iso_fit$yf
  as.numeric(out)
}
